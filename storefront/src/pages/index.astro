---
import Layout from "@/layouts/Layout.astro";
import { queryStrapi, getStrapiMedia } from "@/lib/strapi";
import HeroPrincipal from "@/components/HeroPrincipal.astro";
import BarraBeneficios from "@/components/BarraBeneficios.astro";
import MosaicoCategorias from "@/components/MosaicoCategorias.astro";
import TarjetaProducto from "@/components/TarjetaProducto.astro";
import Boletin from "@/components/Boletin.astro";

// Fetch products from Strapi
let products: any[] = [];
try {
  products = await queryStrapi<any[]>("products", {
    params: {
      populate: "*",
      "pagination[limit]": 8,
    },
  });
} catch (e) {
  console.error("Failed to fetch products:", e);
}
---

<Layout title="Bienvenidos">
  <!-- Hero Section -->
  <HeroPrincipal />

  <!-- Beneficios -->
  <BarraBeneficios />

  <!-- CategorÃ­as -->
  <MosaicoCategorias />

  <!-- Productos Destacados -->
  <section class="py-20 bg-white/[0.02]">
    <div class="max-w-7xl mx-auto px-6 lg:px-20">
      <div class="flex items-center justify-between mb-12">
        <h2 class="text-3xl font-bold tracking-tight text-white font-display">
          Piezas Destacadas
        </h2>
        <a
          href="/productos"
          class="text-zinc-400 hover:text-primary transition-colors text-sm font-bold uppercase tracking-wider"
        >
          Ver todo &rarr;
        </a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        {
          products.length > 0 ? (
            products.map((p) => {
              const mainImage =
                p.images && p.images.length > 0
                  ? getStrapiMedia(p.images[0].url)
                  : undefined;

              return (
                <TarjetaProducto
                  nombre={p.name}
                  precio={p.precio}
                  categoria={p.category?.name || "Premium"}
                  imagen={mainImage}
                  slug={p.slug || ""}
                  badge={p.is_new ? "Nuevo" : undefined}
                />
              );
            })
          ) : (
            <div class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-3xl">
              <p class="text-gray-500 italic">
                No hay productos destacados disponibles actualmente.
              </p>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- Newsletter -->
  <Boletin />
</Layout>
