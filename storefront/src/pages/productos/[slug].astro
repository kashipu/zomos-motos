---
import Layout from "@/layouts/Layout.astro";
import { queryStrapi, getStrapiMedia } from "@/lib/strapi";
import AddToCart from "@/components/AddToCart";
import WhatsAppButton from "@/components/WhatsAppButton";
import ProductSEO from "@/components/ProductSEO.astro";
import MigasPan from "@/components/MigasPan.astro";
import GaleriaImagenes from "@/components/GaleriaImagenes.astro";
import DetalleInfo from "@/components/DetalleInfo.astro";
import FichaTecnica from "@/components/FichaTecnica.astro";
import TarjetaProducto from "@/components/TarjetaProducto.astro";

export const prerender = false;

const { slug } = Astro.params;

let product = null;
let relatedProducts: any[] = [];

try {
  if (!slug) throw new Error("No slug provided");

  // Search for the main product
  const data = await queryStrapi<any[]>("products", {
    params: {
      "filters[slug][$eq]": slug,
      populate: "*",
    },
  });

  if (data && data.length > 0) {
    product = data[0];

    // Search for related products (same category)
    if (product.category) {
      relatedProducts = await queryStrapi<any[]>("products", {
        params: {
          "filters[category][slug][$eq]": product.category.slug,
          "filters[slug][$ne]": slug,
          "pagination[limit]": 4,
          populate: "*",
        },
      });
    }
  }
} catch (e) {
  console.error(`Failed to fetch product with slug ${slug}:`, e);
}

if (!product) {
  return Astro.redirect("/404");
}

const breadcrumbs: { nombre: string; href?: string }[] = [
  { nombre: "Catálogo", href: "/productos" },
];
if (product.category) {
  breadcrumbs.push({
    nombre: product.category.name || "Categoría",
    href: `/productos?category=${product.category.slug}`,
  });
}
breadcrumbs.push({ nombre: product.name || "Producto" });

const gallery =
  product.images?.map((img: any) => ({
    url: getStrapiMedia(img.url) || undefined,
    alt: product.name || "Imagen de producto",
  })) || [];

const compatibility = {
  marca: product.compatibilities?.[0]?.brand || "Universal",
  modelo: product.compatibilities?.[0]?.model || "Todos los modelos",
  anio: product.compatibilities?.[0]?.reference || "N/A",
};
---

<Layout title={product.name}>
  <ProductSEO
    slot="head"
    product={{
      ...product,
      name: product.name || "Producto",
      slug: product.slug || "",
      description: product.description || "Descripción del producto",
      precio: product.precio || 0,
      images: product.images || [],
    }}
  />

  <main class="max-w-[1280px] mx-auto px-6 lg:px-10 py-12">
    <!-- Breadcrumbs -->
    <MigasPan items={breadcrumbs} />

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-20">
      <!-- Image Gallery -->
      <GaleriaImagenes imagenes={gallery} />

      <!-- Product Info -->
      <DetalleInfo
        nombre={product.name || "Producto"}
        marca={product.brand || "Zomos Motos"}
        precio={product.precio || 0}
        referencia={product.referencia || "REF-000"}
        compatibilidad={compatibility}
      >
        <div slot="buy-actions" class="flex flex-col gap-4">
          <AddToCart
            client:load
            product={{
              id: product.documentId,
              name: product.name || "Producto",
              price: product.precio || 0,
              sku: product.referencia || "REF-000",
              image: gallery[0]?.url,
            }}
          />

          <WhatsAppButton
            client:load
            productName={product.name}
            sku={product.referencia}
          />
        </div>
      </DetalleInfo>
    </div>

    <!-- Ficha Técnica & Descripción -->
    <FichaTecnica descripcion={product.description} />

    <!-- Related Products -->
    {
      relatedProducts.length > 0 && (
        <section class="mt-32">
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-3xl font-black text-white uppercase tracking-tight font-display">
              También <span class="text-primario">te puede interesar</span>
            </h2>
            <a
              href="/productos"
              class="text-gray-500 hover:text-white transition-colors text-xs font-bold uppercase tracking-widest"
            >
              Ver catálogo completo
            </a>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            {relatedProducts.map((p) => (
              <TarjetaProducto
                nombre={p.name || "Producto"}
                precio={p.precio || 0}
                categoria={p.category?.name || "Premium"}
                imagen={
                  p.images?.[0]?.url
                    ? getStrapiMedia(p.images[0].url) || undefined
                    : undefined
                }
                slug={p.slug || undefined}
                badge={p.is_new ? "Nuevo" : undefined}
              />
            ))}
          </div>
        </section>
      )
    }
  </main>
</Layout>
